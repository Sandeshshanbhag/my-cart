<div class="home-container">
  <!-- Top Navigation Bar -->
  <nav class="navbar">
    <div class="nav-brand">
      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="9" cy="21" r="1" />
        <circle cx="20" cy="21" r="1" />
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
      </svg>
      <span>My Cart</span>
    </div>

    <div class="nav-actions">
      <span class="user-greeting" *ngIf="user$ | async as user">
        Hello, {{ user.name }}!
        <span class="admin-badge" *ngIf="isAdmin$ | async">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
          </svg>
          Admin
        </span>
      </span>

      <!-- Cart Icon -->
      <div class="cart-icon-wrapper" [class.cart-bounce]="cartBounce" (click)="toggleCart()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="9" cy="21" r="1" />
          <circle cx="20" cy="21" r="1" />
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
        </svg>
        <span class="cart-badge" [class.badge-pop]="cartBounce" *ngIf="(cartItemCount$ | async) as count">
          {{ count }}
        </span>
      </div>

      <!-- Notification Bell -->
      <div class="notification-wrapper">
        <button class="notification-btn" (click)="toggleNotifications()" title="Notifications">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
            <path d="M13.73 21a2 2 0 0 1-3.46 0" />
          </svg>
          <span class="notif-badge" *ngIf="unreadCount > 0">{{ unreadCount }}</span>
        </button>

        <!-- Notification Dropdown -->
        <div class="notification-dropdown" *ngIf="showNotifications">
          <div class="notif-header">
            <h3>Notifications</h3>
            <button class="mark-all-btn" *ngIf="unreadCount > 0" (click)="markAllRead()">Mark all read</button>
          </div>
          <div class="notif-list">
            <div class="notif-loading" *ngIf="loadingNotifications">
              <span class="spinner"></span> Loading...
            </div>
            <div class="notif-empty" *ngIf="!loadingNotifications && notifications.length === 0">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                stroke="#d1d5db" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                <path d="M13.73 21a2 2 0 0 1-3.46 0" />
              </svg>
              <p>No notifications yet</p>
            </div>
            <div class="notif-item" *ngFor="let n of notifications"
              [class.unread]="!n.read" (click)="markNotificationRead(n)">
              <span class="notif-icon">{{ getNotificationIcon(n.type) }}</span>
              <div class="notif-content">
                <h4>{{ n.title }}</h4>
                <p>{{ n.message }}</p>
                <span class="notif-time">{{ n.createdAt | date:'medium' }}</span>
              </div>
              <span class="unread-dot" *ngIf="!n.read"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Create Product (Admin Only) -->
      <button class="create-product-btn" *ngIf="isAdmin$ | async" (click)="navigateToCreateProduct()" title="Create Product">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10" />
          <line x1="12" y1="8" x2="12" y2="16" />
          <line x1="8" y1="12" x2="16" y2="12" />
        </svg>
        <span class="btn-label">Create Product</span>
      </button>

      <!-- Admin Request (only for non-admins) -->
      <button class="admin-request-btn" *ngIf="!(isAdmin$ | async)" (click)="toggleAdminRequest()" title="Request Admin Access">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
        </svg>
      </button>

      <!-- Logout -->
      <button class="logout-btn" (click)="logout()" title="Logout">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
          <polyline points="16 17 21 12 16 7" />
          <line x1="21" y1="12" x2="9" y2="12" />
        </svg>
      </button>
    </div>
  </nav>

  <!-- Notification overlay to close dropdown -->
  <div class="notif-overlay" *ngIf="showNotifications" (click)="toggleNotifications()"></div>

  <!-- Cart Sidebar -->
  <div class="cart-overlay" *ngIf="showCart" (click)="toggleCart()"></div>
  <div class="cart-sidebar" [class.open]="showCart">
    <div class="cart-header">
      <h2>Shopping Cart</h2>
      <button class="close-cart" (click)="toggleCart()">‚úï</button>
    </div>
    <div class="cart-body">
      <ng-container *ngIf="cartItems$ | async as items">
        <div *ngIf="items.length === 0" class="cart-empty">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
            stroke="#d1d5db" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1" />
            <circle cx="20" cy="21" r="1" />
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
          </svg>
          <p>Your cart is empty</p>
        </div>
        <div *ngFor="let item of items" class="cart-item">
          <img [src]="item.product.image" [alt]="item.product.title" />
          <div class="cart-item-info">
            <p class="cart-item-title">{{ item.product.title }}</p>
            <p class="cart-item-price">${{ item.product.price | number:'1.2-2' }}</p>
            <div class="cart-item-qty">
              <button class="cart-qty-btn" (click)="decrementCartItem(item.product.id)">‚àí</button>
              <span class="cart-qty-value">{{ item.quantity }}</span>
              <button class="cart-qty-btn" (click)="incrementCartItem(item.product.id)">+</button>
            </div>
          </div>
          <button class="remove-btn" (click)="removeFromCart(item.product.id)" title="Remove">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6" />
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
            </svg>
          </button>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Admin Request Modal -->
  <div class="modal-overlay" *ngIf="showAdminRequest" (click)="toggleAdminRequest()"></div>
  <div class="admin-request-modal" *ngIf="showAdminRequest">
    <div class="modal-header">
      <h3>
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
        </svg>
        Request Admin Access
      </h3>
      <button class="modal-close" (click)="toggleAdminRequest()">‚úï</button>
    </div>

    <div class="modal-body" *ngIf="!adminRequestSuccess">
      <p class="modal-description">Please provide a reason for requesting admin access. Your request will be reviewed by the team.</p>
      <label for="adminReason">Reason for Request</label>
      <textarea
        id="adminReason"
        [(ngModel)]="adminRequestReason"
        placeholder="Explain why you need admin access..."
        rows="4"
        [disabled]="adminRequestSubmitting"
      ></textarea>
      <button
        class="submit-request-btn"
        (click)="submitAdminRequest()"
        [disabled]="!adminRequestReason.trim() || adminRequestSubmitting"
      >
        <span *ngIf="!adminRequestSubmitting">Submit Request</span>
        <span *ngIf="adminRequestSubmitting" class="btn-loading">
          <span class="spinner"></span>
          Submitting...
        </span>
      </button>
    </div>

    <div class="modal-body success-state" *ngIf="adminRequestSuccess">
      <div class="success-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
          stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
          <polyline points="22 4 12 14.01 9 11.01" />
        </svg>
      </div>
      <h4>Request Submitted!</h4>
      <p>Your admin access request has been sent. You'll be notified once it's reviewed.</p>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Search Section -->
    <div class="search-section">
      <h2>What are you looking for?</h2>
      <div class="search-bar">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"
          fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8" />
          <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
        <input type="text" [(ngModel)]="searchQuery" (input)="onSearchInput()" (keyup.enter)="onSearch()"
          placeholder="Search for products..." />
        <button *ngIf="searchQuery" class="clear-btn" (click)="clearSearch()">‚úï</button>
        <button class="search-btn" (click)="onSearch()">Search</button>
      </div>
    </div>

    <!-- Recent Searches -->
    <div class="recent-searches" *ngIf="(recentSearches$ | async) as recentSearches">
      <div *ngIf="recentSearches.length > 0">
        <h3>Recent Searches</h3>
        <div class="recent-chips">
          <button *ngFor="let term of recentSearches" class="chip" (click)="onRecentSearchClick(term)">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10" />
              <polyline points="12 6 12 12 16 14" />
            </svg>
            {{ term }}
          </button>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div class="loading-container" *ngIf="loading$ | async">
      <div class="loader"></div>
      <p>Searching products...</p>
    </div>

    <!-- Search Results -->
    <div class="search-results" *ngIf="(searchResults$ | async) as results">
      <div *ngIf="results.length > 0 && !(loading$ | async)">
        <h3>Search Results <span class="result-count">({{ results.length }} found)</span></h3>
        <div class="product-grid">
          <app-product-card *ngFor="let product of results" [product]="product"></app-product-card>
        </div>
      </div>
      <div *ngIf="results.length === 0 && !(loading$ | async) && (currentQuery$ | async)" class="no-results">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
          stroke="#d1d5db" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8" />
          <line x1="21" y1="21" x2="16.65" y2="16.65" />
          <line x1="8" y1="8" x2="14" y2="14" />
          <line x1="14" y1="8" x2="8" y2="14" />
        </svg>
        <h3>No products found</h3>
        <p>Try searching with different keywords</p>
      </div>
    </div>

    <!-- Recommended Products (Deferred Loading) -->
    <div class="recommended-section" *ngIf="!(currentQuery$ | async)">
      @defer (on viewport) {
        <ng-container *ngIf="recommended$ | async as recommended">
          <div *ngIf="recommended.length > 0">
            <div class="section-header">
              <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                </svg>
                Recommended for You
              </h3>
            </div>
            <div class="product-grid">
              <app-product-card *ngFor="let product of recommended" [product]="product"></app-product-card>
            </div>
          </div>
        </ng-container>
      } @placeholder {
        <div class="defer-placeholder">
          <div class="section-header">
            <h3>
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
              </svg>
              Recommended for You
            </h3>
          </div>
          <div class="skeleton-grid">
            <div class="skeleton-card" *ngFor="let i of [1,2,3,4]">
              <div class="skeleton-image"></div>
              <div class="skeleton-line title"></div>
              <div class="skeleton-line category"></div>
              <div class="skeleton-line price"></div>
            </div>
          </div>
        </div>
      } @loading (minimum 500ms) {
        <div class="defer-loading">
          <div class="section-header">
            <h3>
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
              </svg>
              Recommended for You
            </h3>
          </div>
          <div class="skeleton-grid">
            <div class="skeleton-card shimmer" *ngFor="let i of [1,2,3,4]">
              <div class="skeleton-image"></div>
              <div class="skeleton-line title"></div>
              <div class="skeleton-line category"></div>
              <div class="skeleton-line price"></div>
            </div>
          </div>
        </div>

      } @error {
        <div class="defer-error">
          <p>Failed to load recommendationssss. Please refresh.</p>
        </div>
      }
    </div>
  </main>

  <!-- AI Chatbox -->
  <div class="chatbox-fab" (click)="toggleChat()" [class.hidden]="isChatOpen" title="Chat with CartBot">
    <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
    </svg>
    <span class="fab-badge" *ngIf="!isChatOpen && chatMessages.length > 0">AI</span>
  </div>

  <div class="chatbox-container" [class.open]="isChatOpen">
    <div class="chatbox-header">
      <div class="chatbox-header-info">
        <div class="chatbot-avatar">ü§ñ</div>
        <div>
          <h4>CartBot</h4>
          <span class="chatbot-status">
            <span class="status-dot"></span>
            AI Shopping Assistant
          </span>
        </div>
      </div>
      <div class="chatbox-header-actions">
        <button class="chat-clear-btn" (click)="clearChat()" title="Clear chat" *ngIf="chatMessages.length > 0">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6" />
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
          </svg>
        </button>
        <button class="chat-close-btn" (click)="toggleChat()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>
    </div>

    <div class="chatbox-messages" #chatMessagesContainer>
      <!-- Welcome message -->
      <div class="chat-message assistant" *ngIf="chatMessages.length === 0">
        <div class="message-avatar">ü§ñ</div>
        <div class="message-bubble">
          <p>Hey there! üëã I'm <strong>CartBot</strong>, your AI shopping assistant.</p>
          <p>Ask me anything about products, deals, or help with your cart!</p>
          <div class="quick-actions">
            <button (click)="sendQuickMessage('What products do you have?')">üõçÔ∏è Browse Products</button>
            <button (click)="sendQuickMessage('Help me find a good phone')">üì± Find a Phone</button>
            <button (click)="sendQuickMessage('How does the cart work?')">üõí Cart Help</button>
          </div>
        </div>
      </div>

      <!-- Chat messages -->
      <div *ngFor="let msg of chatMessages"
        class="chat-message"
        [class.user]="msg.role === 'user'"
        [class.assistant]="msg.role === 'assistant'">
        <div class="message-avatar" *ngIf="msg.role === 'assistant'">ü§ñ</div>
        <div class="message-bubble">
          <p>{{ msg.content }}</p>
          <span class="message-time">{{ msg.timestamp | date:'shortTime' }}</span>
        </div>
        <div class="message-avatar user-avatar" *ngIf="msg.role === 'user'">üë§</div>
      </div>

      <!-- Typing indicator -->
      <div class="chat-message assistant" *ngIf="isChatLoading">
        <div class="message-avatar">ü§ñ</div>
        <div class="message-bubble typing-bubble">
          <div class="typing-indicator">
            <span></span><span></span><span></span>
          </div>
        </div>
      </div>
    </div>

    <div class="chatbox-input">
      <input
        type="text"
        [(ngModel)]="chatInput"
        (keydown.enter)="sendChatMessage()"
        placeholder="Ask CartBot anything..."
        [disabled]="isChatLoading"
        #chatInputField
      />
      <button (click)="sendChatMessage()" [disabled]="!chatInput.trim() || isChatLoading" class="send-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13" />
          <polygon points="22 2 15 22 11 13 2 9 22 2" />
        </svg>
      </button>
    </div>
  </div>
</div>
